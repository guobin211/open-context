## 上下文

实现类似 VS Code 的文件树组件,用于浏览和管理工作空间中的文件。系统需要支持大目录(10 万+文件)的流畅交互,提供按需加载、实时监听、虚拟列表渲染等核心能力。

**技术约束:**

- Tauri 桌面应用架构(Rust 后端 + React 前端)
- 现有技术栈:React 19、Vite、TypeScript、Tailwind CSS
- 需要跨平台支持(Windows、macOS、Linux)

## 目标 / 非目标

**目标:**

- 实现高性能文件树组件,支持 10 万+文件目录流畅交互
- 提供完整的文件操作功能(创建、重命名、删除、搜索)
- 实现实时文件监听,自动更新 UI
- 采用按需加载和虚拟列表优化性能

**非目标:**

- 不实现文件拖拽排序(后续迭代)
- 不实现文件内容预览(由其他组件负责)
- 不实现版本控制集成(Git 功能独立)
- 不实现文件压缩/解压缩功能

## 决策

### 决策 1:采用 Rust 后端 + 前端虚拟列表的分层架构

**理由:**

- Rust 提供高性能的异步文件 IO(tokio::fs)
- 前端虚拟列表减少 DOM 节点数量,提升渲染性能
- 分离关注点:Rust 负责文件系统操作,前端负责 UI 渲染

**考虑的替代方案:**

- 纯前端实现:性能不足,无法处理大目录
- 全部在 Rust 实现 UI:开发效率低,不符合项目架构

### 决策 2:使用 @tanstack/react-virtual 实现虚拟列表

**理由:**

- 成熟的虚拟滚动库,性能优秀
- API 简洁,易于集成
- 支持动态高度和固定高度两种模式

**考虑的替代方案:**

- react-window:功能较简单,不支持动态高度
- 自行实现:开发成本高,性能未必更好

### 决策 3:实现双层缓存机制(Rust + 前端)

**理由:**

- Rust 缓存避免重复的文件系统 IO
- 前端缓存减少 IPC 通信次数
- 缓存过期时间设置为 5 分钟,平衡实时性和性能

**考虑的替代方案:**

- 仅 Rust 缓存:前端仍需频繁 IPC 调用
- 仅前端缓存:无法避免 Rust 层的重复 IO

### 决策 4:使用 notify 库实现文件监听

**理由:**

- 跨平台支持(Windows、macOS、Linux)
- 成熟稳定,社区活跃
- 支持递归监听目录

**考虑的替代方案:**

- 轮询机制:性能差,延迟高
- 平台特定 API:需要维护多套代码

### 决策 5:文件监听事件防抖 50ms

**理由:**

- 避免频繁文件变化导致 UI 闪烁
- 减少不必要的缓存失效和重新渲染
- 50ms 在实时性和性能间取得平衡

### 决策 6:按需加载策略

**理由:**

- 不预加载全量目录树,仅加载用户展开的节点
- 显著减少初始加载时间和内存占用
- 适合处理大目录结构

## 风险 / 权衡

### 风险 1:文件监听性能问题

**风险:** 监听大目录时,频繁的文件变化可能导致性能下降

**缓解措施:**

- 实现 50ms 防抖机制
- 仅监听用户打开的工作空间根目录
- 批量处理文件变化事件

### 风险 2:跨平台路径兼容性

**风险:** Windows 使用反斜杠,Unix 使用正斜杠,可能导致路径错误

**缓解措施:**

- 使用 path-slash 库统一路径分隔符
- Rust 层使用 std::path::Path 处理路径
- 前端使用 path-browserify 库

### 风险 3:文件权限问题

**风险:** 某些系统目录可能无权限访问,导致错误

**缓解措施:**

- Rust 层捕获权限错误,返回友好提示
- 前端显示错误状态,不中断整体流程
- tauri.conf.json 配置合理的文件系统权限范围

### 风险 4:缓存一致性

**风险:** 缓存可能与文件系统实际状态不同步

**缓解措施:**

- 文件监听实时更新缓存
- 提供手动刷新按钮
- 设置缓存过期时间(5 分钟)

## 迁移计划

### 步骤 1:Rust 后端实现

1. 添加依赖项到 Cargo.toml
2. 实现核心数据结构和缓存机制
3. 实现所有 Tauri 命令并注册
4. 编写单元测试验证功能

### 步骤 2:前端状态管理

1. 安装前端依赖(@tanstack/react-virtual、path-browserify)
2. 实现 FileTreeService 类
3. 实现事件监听和状态更新逻辑

### 步骤 3:前端组件开发

1. 实现 FileTreeItem 节点组件
2. 实现 FileTree 主组件,集成虚拟列表
3. 添加交互功能(展开/折叠、右键菜单)

### 步骤 4:高级功能

1. 实现文件搜索组件
2. 实现路径导航面包屑
3. 优化性能和用户体验

### 步骤 5:测试与优化

1. 单元测试(Rust + TypeScript)
2. 大目录性能测试(10 万+文件)
3. 跨平台兼容性测试

### 回滚方案

如果出现严重问题,可以:

1. 禁用文件树组件入口
2. 回退到简单的文件列表视图
3. 保留 Rust 命令,仅回退前端组件

## 待决问题

- 是否需要支持符号链接(symlink)?
- 文件图标方案:使用内置图标还是集成 vscode-icons?
- 是否需要支持 .gitignore 规则过滤文件?
- 右键菜单是使用原生菜单还是 Web 组件?
