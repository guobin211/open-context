# 功能规范：数据存储设置

## 概述

数据存储设置页面允许用户配置本地数据存储路径、缓存管理和备份策略。

## 新增需求

### 需求：用户可以更改本地存储路径

应用**必须**提供本地存储路径配置功能，用户**必须**能够更改数据存储位置，系统**必须**将现有数据迁移到新路径。

#### 场景：用户更改数据存储位置

**操作步骤**：

1. 用户点击"更改路径"按钮
2. 系统打开文件夹选择对话框
3. 用户选择新的存储路径（如 `/Users/username/Documents/OpenContext`）
4. 系统提示："更改存储路径将迁移所有现有数据，是否继续？"
5. 用户确认

**预期结果**：

- 系统将现有数据迁移到新路径
- 显示迁移进度（文件数、大小）
- 迁移完成后，应用使用新路径
- 旧路径数据可选择保留或删除

**边界情况**：

- 新路径空间不足：提示用户并取消操作
- 迁移失败：回滚到原路径，显示错误信息

### 需求：用户可以查看存储使用情况

应用**必须**显示本地存储使用情况，包括总使用空间和按类型分组的数据占用情况。

#### 场景：用户查看数据占用

**预期结果**：

- 显示总使用空间（如"2.5 GB"）
- 按类型分组显示：
  - 笔记数据：800 MB
  - 文件资源：1.5 GB
  - 缓存：200 MB
  - 索引数据：50 MB

### 需求：用户可以配置缓存管理

应用**必须**提供缓存管理功能，用户**必须**能够设置最大缓存大小和启用自动清理功能。

#### 场景：用户设置最大缓存大小

**操作步骤**：

1. 用户在"最大缓存大小"输入框输入 500（MB）
2. 启用"自动清理"开关

**预期结果**：

- 缓存超过 500 MB 时，自动清理最旧的缓存
- 清理策略：LRU（最近最少使用）

### 需求：用户可以启用自动备份

应用**必须**提供自动备份功能，用户**必须**能够配置备份路径和备份频率。

#### 场景：用户配置自动备份

**操作步骤**：

1. 用户启用"自动备份"开关
2. 点击"选择备份路径"
3. 选择备份目录（如外置硬盘）
4. 设置备份频率（如"每天"）

**预期结果**：

- 应用每天自动备份数据到指定路径
- 备份文件命名：`open-context-backup-2024-01-20.zip`
- 保留最近 7 天的备份

## UI 布局

```
┌─────────────────────────────────────────────────┐
│  数据存储设置                                     │
├─────────────────────────────────────────────────┤
│                                                 │
│  本地存储路径                                     │
│  /Users/username/.config/open-context           │
│  [更改路径]                                      │
│                                                 │
│  ─────────────────────────────────────────      │
│                                                 │
│  存储使用情况                                     │
│  总计：2.5 GB                                    │
│  • 笔记数据：800 MB                              │
│  • 文件资源：1.5 GB                              │
│  • 缓存：200 MB                                  │
│  • 索引数据：50 MB                               │
│                                                 │
│  ─────────────────────────────────────────      │
│                                                 │
│  最大缓存大小（MB）                               │
│  ┌────────────────────────────────────────┐    │
│  │ 500                                     │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  自动清理缓存                          [  ON ]  │
│  超过最大缓存大小时自动清理旧缓存                  │
│                                                 │
│  [立即清理缓存]                                  │
│                                                 │
│  ─────────────────────────────────────────      │
│                                                 │
│  自动备份                              [ OFF ]  │
│                                                 │
│  备份路径                                        │
│  /Volumes/Backup/OpenContext                    │
│  [选择备份路径]                                  │
│                                                 │
│  备份频率                                        │
│  ┌────────────────────────────────────────┐    │
│  │ 每天                            ▼       │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  [立即备份]                                      │
│                                                 │
└─────────────────────────────────────────────────┘
```

## 技术实现

### 类型定义

```typescript
interface StorageConfig {
  localPath: string;
  maxCacheSize: number; // MB
  autoCleanup: boolean;
  backupEnabled: boolean;
  backupPath: string;
  backupFrequency: 'daily' | 'weekly' | 'monthly';
}
```

### Tauri 命令

```rust
// src/app_commands.rs
#[tauri::command]
async fn change_storage_path(new_path: String) -> Result<(), String> {
    // 迁移数据逻辑
}

#[tauri::command]
async fn get_storage_usage() -> Result<StorageUsage, String> {
    // 计算存储使用情况
}

#[tauri::command]
async fn clear_cache() -> Result<(), String> {
    // 清理缓存
}
```

## 数据验证

- 存储路径必须是有效的目录路径
- 最大缓存大小必须大于 0
- 备份路径必须可写

## 相关功能

- **云存储设置**：本地路径与云端同步路径关联
- **笔记管理**：笔记数据存储在本地路径
