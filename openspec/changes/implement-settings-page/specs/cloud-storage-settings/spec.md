# 功能规范：云存储设置

## 概述

云存储设置页面允许用户配置腾讯云 COS（对象存储）服务，实现文件和笔记的云端同步。

## 新增需求

### 需求：用户可以启用云存储功能

应用**必须**提供云存储配置功能，用户**必须**能够启用云存储并配置腾讯云 COS 服务，实现文件和笔记的云端同步。

#### 场景：用户配置 COS 并测试连接

**前置条件**：

- 用户已拥有腾讯云账号和 COS bucket

**操作步骤**：

1. 用户开启"启用云存储"开关
2. 选择提供商："腾讯云 COS"
3. 输入 SecretId、SecretKey
4. 选择区域（如"广州 ap-guangzhou"）
5. 输入 Bucket 名称
6. 点击"测试连接"按钮

**预期结果**：

- 系统验证凭证有效性
- 显示"连接成功"提示
- 配置自动保存（SecretKey 加密存储）

**边界情况**：

- SecretId/Key 错误：显示"认证失败"错误
- 网络不可用：显示"网络错误"提示
- Bucket 不存在：显示"Bucket 不存在"错误

### 需求：用户可以选择同步策略

应用**必须**提供同步策略选择功能，用户**必须**能够选择自动同步、手动同步或仅在 WiFi 下同步。

#### 场景：用户设置仅在 WiFi 下同步

**操作步骤**：

1. 在"同步策略"中选择"仅 WiFi"

**预期结果**：

- 应用仅在连接 WiFi 时同步文件
- 使用移动网络时，不进行同步
- 显示提示："当前使用移动网络，已暂停同步"

### 需求：用户可以查看存储空间使用情况

应用**必须**显示云存储空间使用情况，包括已使用空间、总空间、同步文件数量和最后同步时间。

#### 场景：用户查看存储信息

**预期结果**：

- 显示已使用空间（如"1.2 GB / 50 GB"）
- 显示同步文件数量
- 显示最后同步时间

## UI 布局

```
┌─────────────────────────────────────────────────┐
│  云存储设置                                      │
├─────────────────────────────────────────────────┤
│                                                 │
│  启用云存储                            [  ON ]  │
│                                                 │
│  ─────────────────────────────────────────      │
│                                                 │
│  提供商                                          │
│  ┌────────────────────────────────────────┐    │
│  │ 腾讯云 COS                      ▼       │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  SecretId                                       │
│  ┌────────────────────────────────────────┐    │
│  │ AKIDxxxxxxxxxxxxxxxxxxxx                │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  SecretKey                                      │
│  ┌────────────────────────────────────────┐    │
│  │ ********** [显示]                       │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  区域                                            │
│  ┌────────────────────────────────────────┐    │
│  │ 广州（ap-guangzhou）            ▼       │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  Bucket 名称                                     │
│  ┌────────────────────────────────────────┐    │
│  │ my-bucket-1250000000                    │    │
│  └────────────────────────────────────────┘    │
│                                                 │
│  [测试连接]                                      │
│                                                 │
│  ─────────────────────────────────────────      │
│                                                 │
│  同步策略                                        │
│  ○ 自动同步  ○ 手动同步  ● 仅 WiFi              │
│                                                 │
│  ─────────────────────────────────────────      │
│                                                 │
│  存储空间使用情况                                 │
│  已使用：1.2 GB / 50 GB                          │
│  同步文件：234 个                                │
│  最后同步：2 分钟前                               │
│                                                 │
└─────────────────────────────────────────────────┘
```

## 技术实现

### 类型定义

```typescript
interface CloudStorageConfig {
  enabled: boolean;
  provider: 'cos' | 's3' | 'oss';
  cosConfig: {
    secretId: string;
    secretKey: string;
    region: string;
    bucket: string;
    pathPrefix?: string;
  };
  syncStrategy: 'auto' | 'manual' | 'wifi-only';
  autoSyncInterval?: number; // 分钟
  excludePatterns: string[];
}

// 腾讯云区域列表
const COS_REGIONS = [
  { value: 'ap-guangzhou', label: '广州' },
  { value: 'ap-shanghai', label: '上海' },
  { value: 'ap-beijing', label: '北京' },
  { value: 'ap-chengdu', label: '成都' }
  // ...
];
```

### 测试连接实现

```typescript
const testCOSConnection = async (config: COSConfig) => {
  try {
    const response = await invoke('test_cos_connection', { config });
    if (response.success) {
      showToast('连接成功', 'success');
    }
  } catch (error) {
    showToast(`连接失败: ${error.message}`, 'error');
  }
};
```

## 数据验证

- SecretId 格式：以 "AKID" 开头，40 个字符
- SecretKey 格式：32 个字符
- Bucket 格式：`{name}-{appid}`，appid 为 10 位数字
- Region 必须在预定义列表中

## 相关功能

- **数据存储设置**：本地路径与云端同步路径的映射关系
- **服务器设置**：云同步可能需要 Open-Node 服务支持
