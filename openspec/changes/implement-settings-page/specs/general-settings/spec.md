# 功能规范：通用设置

## 概述

通用设置页面提供应用的基础配置选项，包括语言选择、自动更新、启动行为等。

## 新增需求

### 需求：用户可以选择应用界面语言

应用**必须**提供语言选择功能，用户**必须**能够在 5 种语言（简体中文、繁体中文、English、日本語、한국어）之间切换界面语言。

#### 场景：用户切换界面语言

**前置条件**：

- 用户已打开设置页面
- 当前在"通用设置"标签页

**操作步骤**：

1. 用户在"语言"下拉菜单中看到可选语言列表：
   - 简体中文（zh-CN）
   - 繁体中文（zh-TW）
   - English（en）
   - 日本語（ja）
   - 한국어（ko）
2. 用户选择目标语言（如"English"）
3. 界面立即切换为选定语言
4. 语言选择自动保存

**预期结果**：

- 应用界面所有文本切换为选定语言
- 下次打开应用时，保持该语言设置

**边界情况**：

- 如果浏览器不支持某些字体，显示系统默认字体

---

### 需求：用户可以启用或禁用自动更新

应用**必须**提供自动更新开关，用户**必须**能够控制应用是否自动检查并安装更新。

#### 场景：用户启用自动更新

**前置条件**：

- 用户已打开设置页面
- 当前在"通用设置"标签页
- "自动更新"开关处于关闭状态

**操作步骤**：

1. 用户点击"自动更新"开关
2. 开关切换到开启状态

**预期结果**：

- 应用在后台定期检查更新（每 24 小时）
- 发现新版本时自动下载并提示用户安装

**边界情况**：

- 如果网络不可用，静默失败，下次检查时重试

#### 场景：用户禁用自动更新

**前置条件**：

- "自动更新"开关处于开启状态

**操作步骤**：

1. 用户点击"自动更新"开关
2. 开关切换到关闭状态

**预期结果**：

- 应用停止自动检查更新
- 用户需要手动检查更新

---

### 需求：用户可以设置应用开机自启动

应用**必须**提供开机自启动开关，用户**必须**能够设置应用在系统启动时自动运行。

#### 场景：用户启用开机启动

**前置条件**：

- 用户已打开设置页面
- 当前在"通用设置"标签页
- "开机启动"开关处于关闭状态

**操作步骤**：

1. 用户点击"开机启动"开关
2. 开关切换到开启状态
3. 系统可能弹出权限请求对话框（macOS/Linux）

**预期结果**：

- 应用注册到系统自启动列表
- 系统重启后，应用自动启动

**边界情况**：

- 如果用户拒绝权限请求，显示错误提示
- 在 Windows 上，需要写入注册表或启动文件夹
- 在 macOS 上，使用 LaunchAgents
- 在 Linux 上，使用 systemd 或 autostart

#### 场景：用户禁用开机启动

**前置条件**：

- "开机启动"开关处于开启状态

**操作步骤**：

1. 用户点击"开机启动"开关
2. 开关切换到关闭状态

**预期结果**：

- 应用从系统自启动列表中移除
- 系统重启后，应用不会自动启动

---

### 需求：用户可以设置最小化行为

应用**必须**提供"最小化到托盘"开关，用户**必须**能够控制点击窗口关闭按钮时的行为（最小化到托盘或完全退出）。

#### 场景：用户启用"最小化到托盘"

**前置条件**：

- 用户已打开设置页面
- 当前在"通用设置"标签页
- "最小化到托盘"开关处于关闭状态

**操作步骤**：

1. 用户点击"最小化到托盘"开关
2. 开关切换到开启状态

**预期结果**：

- 用户点击窗口关闭按钮时，应用最小化到系统托盘
- 托盘图标显示应用仍在运行
- 用户需要从托盘菜单"退出"才能完全关闭应用

**边界情况**：

- 在不支持系统托盘的环境中（部分 Linux 桌面），提示用户不支持

#### 场景：用户禁用"最小化到托盘"

**前置条件**：

- "最小化到托盘"开关处于开启状态

**操作步骤**：

1. 用户点击"最小化到托盘"开关
2. 开关切换到关闭状态

**预期结果**：

- 用户点击窗口关闭按钮时，应用完全退出

---

## UI 布局

```
┌─────────────────────────────────────────────────┐
│  通用设置                                        │
├─────────────────────────────────────────────────┤
│                                                 │
│  语言                                           │
│  ┌────────────────────────────────────────┐    │
│  │ 简体中文                        ▼       │    │
│  └────────────────────────────────────────┘    │
│  选择应用界面语言                                │
│                                                 │
│  ─────────────────────────────────────────      │
│                                                 │
│  自动更新                              [  ON ]  │
│  自动检查并安装应用更新                          │
│                                                 │
│  ─────────────────────────────────────────      │
│                                                 │
│  开机启动                              [ OFF ]  │
│  系统启动时自动运行应用                          │
│                                                 │
│  ─────────────────────────────────────────      │
│                                                 │
│  最小化到托盘                          [ OFF ]  │
│  点击关闭按钮时最小化到系统托盘，而不是退出应用   │
│                                                 │
└─────────────────────────────────────────────────┘
```

## 技术实现

### 类型定义

```typescript
interface GeneralConfig {
  language: 'zh-CN' | 'zh-TW' | 'en' | 'ja' | 'ko';
  autoUpdate: boolean;
  startOnBoot: boolean;
  minimizeToTray: boolean;
}
```

### 组件接口

```typescript
// general-settings.tsx
const GeneralSettings: React.FC = () => {
  const { config, setConfig } = useSettingsStore();
  const { i18n } = useTranslation();

  const handleLanguageChange = (language: string) => {
    setConfig({ general: { ...config.general, language } });
    i18n.changeLanguage(language);
  };

  // ... 其他处理函数
};
```

### Tauri 命令集成（开机启动和托盘）

```typescript
// 调用 Tauri 命令设置开机启动
import { invoke } from '@tauri-apps/api/core';

const handleStartOnBootToggle = async (enabled: boolean) => {
  try {
    await invoke('set_auto_launch', { enabled });
    setConfig({ general: { ...config.general, startOnBoot: enabled } });
  } catch (error) {
    console.error('Failed to set auto launch:', error);
    // 显示错误提示
  }
};
```

## 数据验证

- 语言必须是预定义的 5 种之一
- 所有布尔值必须是 `true` 或 `false`

## 国际化

所有文本需要支持 5 种语言：

```json
{
  "settings": {
    "general": {
      "title": "通用设置",
      "language": {
        "label": "语言",
        "description": "选择应用界面语言"
      },
      "autoUpdate": {
        "label": "自动更新",
        "description": "自动检查并安装应用更新"
      },
      "startOnBoot": {
        "label": "开机启动",
        "description": "系统启动时自动运行应用"
      },
      "minimizeToTray": {
        "label": "最小化到托盘",
        "description": "点击关闭按钮时最小化到系统托盘，而不是退出应用"
      }
    }
  }
}
```

## 相关功能

- **外观设置**：主题切换会影响界面语言显示效果
- **服务器设置**：自动启动 Open-Node 服务器与应用自启动相关
