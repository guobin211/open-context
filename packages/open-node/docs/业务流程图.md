## 一、系统总览架构图（模块级）

```
┌─────────────────────────────┐
│           Client            │
│  Web / CLI / IDE Plugin     │
└──────────────┬──────────────┘
               │ HTTP
               ▼
┌────────────────────────────────────────┐
│              API Layer                 │
│  src/api/                              │
│  ├─ workspace-routes.ts                │
│  ├─ repo-routes.ts                     │
│  ├─ index-routes.ts                    │
│  ├─ query-routes.ts                    │
│  └─ graph-routes.ts                    │
└──────────────┬─────────────────────────┘
               │
               ▼
┌────────────────────────────────────────┐
│            Service Layer               │
│  src/services/                         │
│  ├─ workspace-service.ts               │
│  ├─ repo-service.ts                    │
│  ├─ indexer-service.ts                 │
│  ├─ vector-service.ts                  │
│  ├─ graph-service.ts                   │
│  └─ rag-service.ts                     │
└───────┬───────────────┬────────────────┘
        │               │
        │               │
        ▼               ▼
┌───────────────┐   ┌───────────────────┐
│   Qdrant      │   │   Graph System     │
│  (Vectors)    │   │  (In-Memory + DB)  │
│               │   │                   │
│ code_symbols  │   │ out/in adjacency   │
└───────────────┘   └─────────┬─────────┘
                               │
                               ▼
                      ┌─────────────────┐
                      │   LevelDB       │
                      │  data/leveldb   │
                      └─────────────────┘
```

---

## 二、索引流程图（Repo → 向量 + 图）

> 对应：`indexer-service` + `jobs/index-job.ts` + `indexers/*`

```
┌────────────────────────┐
│   Start Index Repo     │
│  POST /repos/:id/index │
└────────────┬───────────┘
             ▼
┌────────────────────────┐
│  indexer-service.ts    │
└────────────┬───────────┘
             ▼
┌────────────────────────┐
│   Git Clone / Pull     │
│   utils/git.ts         │
└────────────┬───────────┘
             ▼
┌────────────────────────┐
│   AST Parse            │
│  indexers/ast-parser   │
└────────────┬───────────┘
             ▼
┌────────────────────────┐
│   Symbol Extract       │
│ indexers/symbol-...    │
│  - function            │
│  - class               │
│  - method              │
└────────────┬───────────┘
             ▼
┌────────────────────────┐
│ Code Chunk Builder     │
│  - code                │
│  - signature           │
│  - doc comments        │
└────────────┬───────────┘
             │
     ┌───────┴─────────┐
     │                 │
     ▼                 ▼
┌───────────────┐   ┌───────────────────┐
│  Embedding    │   │  Graph Builder     │
│ utils/vector  │   │ indexers/graph-.. │
└───────┬───────┘   │ - CALLS           │
        │           │ - IMPORTS         │
        ▼           │ - EXTENDS         │
┌───────────────┐   └─────────┬─────────┘
│   Qdrant      │             │
│  upsert       │             ▼
└───────────────┘     ┌─────────────────┐
                      │ graph-service   │
                      │ in-memory graph │
                      └────────┬────────┘
                               ▼
                        ┌──────────────┐
                        │  LevelDB     │
                        │  persist     │
                        └──────────────┘
```

**关键设计点：**

- Symbol 是**向量与图的共同原子**
- 图是 **删旧 → 重建（文件级）**
- 向量是 **upsert（symbol_id + commit）**

---

## 三、查询流程图（RAG 核心）

> 对应：`query-routes.ts` → `rag-service.ts`

```
┌──────────────────────────┐
│   User Query             │
│ "token 是怎么校验的？"    │
└────────────┬─────────────┘
             ▼
┌──────────────────────────┐
│  rag-service.ts          │
└────────────┬─────────────┘
             ▼
┌──────────────────────────┐
│  Embedding Query         │
│  utils/vector.ts         │
└────────────┬─────────────┘
             ▼
┌──────────────────────────┐
│  Qdrant Search           │
│  - workspace filter     │
│  - repo filter          │
└────────────┬─────────────┘
             ▼
┌──────────────────────────┐
│ Top-K Symbols            │
│ verifyToken              │
│ validateJWT              │
└────────────┬─────────────┘
             ▼
┌──────────────────────────┐
│ Graph Expansion          │
│ graph-service.ts         │
│ - CALLS                  │
│ - IMPORTS                │
└────────────┬─────────────┘
             ▼
┌──────────────────────────┐
│ Context Builder          │
│ - primary symbols        │
│ - dependencies           │
│ - deduplicate            │
└────────────┬─────────────┘
             ▼
┌──────────────────────────┐
│        LLM               │
│   Answer / RAG Output    │
└──────────────────────────┘
```

---

## 四、Symbol / Graph / Vector 的统一关系图

```
┌─────────────────────────────┐
│ Symbol                      │
│ ws/repo/file#symbol         │
└──────────────┬──────────────┘
               │
     ┌─────────┴──────────┐
     │                    │
     ▼                    ▼
┌───────────────┐   ┌──────────────────┐
│ Qdrant Vector │   │ Graph Node        │
│ code_symbols  │   │ (string id only)  │
└───────────────┘   └─────────┬────────┘
                               │
                               ▼
                        ┌──────────────┐
                        │ Graph Edge   │
                        │ CALLS        │
                        │ IMPORTS      │
                        └──────────────┘
```
